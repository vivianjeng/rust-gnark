name: Build and Test

on:
    push:
        branches: [main]
    pull_request:
        types:
            - opened
            - synchronize
            - reopened

env:
    CARGO_TERM_COLOR: always

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-go@v5
              with:
                  go-version: "1.24"
            - name: Install Rust components
              run: rustup component add rustfmt clippy
            - name: Check formatting
              run: cargo fmt --all -- --check
            - name: Run Clippy
              env:
                  RUSTFLAGS: "-Dwarnings"
              run: cargo clippy --all-targets

    test:
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-go@v5
              with:
                  go-version: "1.24"
            - name: Run tests
              run: cargo test --all
