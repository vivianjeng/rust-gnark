name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        uses: ./.github/workflows/pre-release.yml

    release:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable

            - name: Extract version
              id: version
              run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

            - name: Download all prebuilt artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Organize into prebuilt directory
              run: |
                  for dir in artifacts/prebuilt-*; do
                    target=$(basename "$dir" | sed 's/^prebuilt-//')
                    mkdir -p "crates/prebuilt/$target"
                    cp "$dir"/libgnark.* "crates/prebuilt/$target/"
                    echo "Packaged prebuilt/$target: $(ls crates/prebuilt/$target/)"
                  done
                  echo "=== All prebuilt targets ==="
                  ls -lR crates/prebuilt/

            - name: Create release archive
              run: |
                  tar -czf prebuilt-all.tar.gz -C crates prebuilt
                  echo "Archive size: $(du -sh prebuilt-all.tar.gz | cut -f1)"

            - name: Verify crate packaging
              run: cargo package --list --allow-dirty -p rust-gnark --manifest-path crates/Cargo.toml

            - name: Publish to crates.io
              if: startsWith(github.ref, 'refs/tags/')
              run: cargo publish --allow-dirty -p rust-gnark --manifest-path crates/Cargo.toml
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  files: prebuilt-all.tar.gz
                  generate_release_notes: true
                  body: |
                      ## rust-gnark ${{ github.ref_name }}

                      Rust bindings for gnark Groth16 BN254 prover/verifier.

                      ### Install

                      ```toml
                      [dependencies]
                      rust-gnark = "${{ steps.version.outputs.version }}"
                      ```

                      Or via `cargo add rust-gnark`.

                      **No Go toolchain required** -- prebuilt static libraries are bundled in the crate.

                      Crate: [crates.io/crates/rust-gnark](https://crates.io/crates/rust-gnark)

                      ### Prebuilt static libraries

                      Also available as `prebuilt-all.tar.gz` for manual use. Extract into `crates/` to populate `prebuilt/<target>/`.

                      | Target | Platform |
                      |--------|----------|
                      | `aarch64-apple-ios` | iOS device (ARM64) |
                      | `aarch64-apple-ios-sim` | iOS simulator (ARM64) |
                      | `x86_64-apple-ios` | iOS simulator (x86_64) |
                      | `aarch64-apple-darwin` | macOS (Apple Silicon) |
                      | `x86_64-apple-darwin` | macOS (Intel) |
                      | `aarch64-linux-android` | Android (ARM64) |
                      | `x86_64-linux-android` | Android (x86_64) |
                      | `x86_64-unknown-linux-gnu` | Linux (x86_64) |
                      | `aarch64-unknown-linux-gnu` | Linux (ARM64) |

            - name: Upload prebuilt archive (workflow_dispatch)
              if: "!startsWith(github.ref, 'refs/tags/')"
              uses: actions/upload-artifact@v4
              with:
                  name: prebuilt-all
                  path: prebuilt-all.tar.gz
